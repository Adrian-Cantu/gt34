
test_that("get_pop_metrics produce the aprropiated output", {
  tt1 <- gt34::get_pop_metrics(gt34::intSitesCART)

  tt2<-  #from dump('tt1',file='',control = "exact")
    structure(list(timePointDays = c(0x0p+0, 0x0p+0, 0x1.ap+3, 0x1.cp+3,
0x1.cp+3, 0x1.cp+4, 0x1.cp+4, 0x1.cp+4, 0x1.cp+4, 0x1.cp+4, 0x1.cp+4,
0x1.9p+5, 0x1.e8p+5, 0x1.6cp+6, 0x1.e8p+6, 0x1.e8p+6, 0x1.3p+7,
0x1.6ep+7, 0x1.6ep+7, 0x1.12p+8, 0x1.6dp+8, 0x1.6dp+8, 0x1.6dp+8,
0x1.c8p+8, 0x1.c8p+8, 0x1.12p+9, 0x1.12p+9, 0x1.3f8p+9, 0x1.3f8p+9,
0x1.6dp+9, 0x1.e68p+9, 0x1.11cp+10, 0x1.6dp+10, 0x1.6dp+10, 0x1.9a8p+10,
0x1.c84p+10, 0x1.c84p+10, 0x1.f6p+10, 0x1.f6p+10, 0x1.11cp+11,
0x1.288p+11, 0x1.3f6p+11, 0x1.6dp+11, 0x1.7c4p+11, 0x1.9aap+11,
0x1.c84p+11), timePoint = c("D0", "D0", "D13", "D14", "D14",
"D28", "D28", "D28", "D28", "D28", "D28", "D50", "M2", "M3",
"M4", "M4", "M5", "M6", "M6", "M9", "M12", "Y1", "Y1", "M15",
"M15", "M18", "M18", "M21", "M21", "Y2", "M32", "Y3", "Y4", "Y4",
"Y4.5", "Y5", "Y5", "Y5.5", "Y5.5", "Y6", "Y6.5", "Y7", "Y8",
"M100", "Y9", "Y10"), cellType = c("T cells", "T cells", "Whole Blood",
"Tcells:CAR+CD8-", "Tcells:CAR+CD8+", "Bone Marrow", "Bone Marrow",
"PBMC", "Tcells:CAR+CD8-", "Tcells:CAR+CD8+", "Whole blood",
"PBMC", "Whole Blood", "Whole Blood", "Bone Marrow", "Whole blood",
"PBMC", "Bone Marrow", "PBMC", "PBMC", "Whole blood", "PBMC",
"PBMC", "Whole blood", "Whole Blood", "PBMC", "Whole blood",
"PBMC", "Whole blood", "Whole blood", "Whole blood", "PBMC",
"PBMC", "PBMC", "PBMC", "PBMC", "PBMC", "PBMC", "PBMC", "PBMC",
"PBMC", "PBMC", "Whole blood", "Whole blood", "Whole blood",
"Whole Blood"), patient = c("p04409-01", "p04409-02", "p04409-01",
"p04409-01", "p04409-01", "p04409-01", "p04409-02", "p04409-02",
"p04409-02", "p04409-02", "p04409-01", "p04409-02", "p04409-01",
"p04409-01", "p04409-02", "p04409-02", "p04409-02", "p04409-02",
"p04409-02", "p04409-01", "p04409-02", "p04409-01", "p04409-02",
"p04409-02", "p04409-01", "p04409-01", "p04409-02", "p04409-01",
"p04409-02", "p04409-02", "p04409-02", "p04409-01", "p04409-01",
"p04409-02", "p04409-02", "p04409-01", "p04409-02", "p04409-01",
"p04409-02", "p04409-02", "p04409-02", "p04409-02", "p04409-01",
"p04409-01", "p04409-01", "p04409-01"), numUniqSites = c(3246L,
1176L, 1319L, 331L, 1535L, 189L, 155L, 205L, 311L, 232L, 34L,
382L, 11L, 506L, 278L, 105L, 32L, 90L, 69L, 356L, 32L, 55L, 17L,
91L, 10L, 308L, 164L, 66L, 42L, 136L, 34L, 89L, 48L, 62L, 345L,
310L, 72L, 64L, 67L, 66L, 48L, 174L, 20L, 129L, 25L, 30L), maxRelAbund = c(0x1.6984a1c78346cp-4,
0x1.ff25e8ff92f48p-3, 0x1.a107dde11a107p+0, 0x1.9745d1745d174p+1,
0x1.26b97d6d02c2cp+1, 0x1.7717717717717p+2, 0x1.5d1ef961b00ccp+4,
0x1.4p+4, 0x1.24433265cc594p+5, 0x1.a9455067824f8p+4, 0x1.6db6db6db6db7p+2,
0x1.ff0c9913ba97bp+3, 0x1.22e8ba2e8ba2fp+3, 0x1.c25ed097b425fp+1,
0x1.b9611a7b9611ap+3, 0x1.48d59857f36f8p+4, 0x1.3021d9ead7cd4p+4,
0x1.1333333333333p+4, 0x1.14ec4ec4ec4ecp+4, 0x1.a3e8d523e8d53p+2,
0x1.c42c8590b2164p+4, 0x1.07bc7bc7bc7bcp+4, 0x1.0aaaaaaaaaaaap+5,
0x1.afe6df04b62f2p+3, 0x1.0aaaaaaaaaaaap+5, 0x1.1c71c71c71c72p+2,
0x1.7bc43bc43bc43p+4, 0x1.1b6db6db6db6dp+4, 0x1.4c77b03531decp+3,
0x1.0bf14d2adeedap+4, 0x1.4p+5, 0x1.874de9bd37a6fp+4, 0x1.225ed097b425fp+5,
0x1.59p+5, 0x1.576a2576a2577p+2, 0x1.9e1e1e1e1e1e3p+4, 0x1.92cc157b86441p+4,
0x1.d555555555555p+4, 0x1.3a49249249249p+3, 0x1.4p+3, 0x1.ep+3,
0x1.7555555555555p+3, 0x1.0aaaaaaaaaaaap+4, 0x1.12d8bc775ca9ap+3,
0x1.bc71c71c71c72p+3, 0x1.aaaaaaaaaaaabp+1), numClones = c(3399L,
1202L, 2701L, 440L, 3431L, 273L, 967L, 945L, 1021L, 2216L, 35L,
2154L, 11L, 540L, 609L, 326L, 121L, 250L, 156L, 442L, 138L, 91L,
54L, 163L, 15L, 405L, 257L, 175L, 77L, 209L, 70L, 184L, 135L,
160L, 410L, 550L, 143L, 150L, 112L, 120L, 100L, 240L, 30L, 163L,
36L, 30L), Shannon = c(0x1.022380711a8a5p+3, 0x1.c3de68b72ddcdp+2,
0x1.a8f8aa1a2901ap+2, 0x1.6856e2d9f4c9ep+2, 0x1.ab5237d3c132ap+2,
0x1.3cbee3fdd5d52p+2, 0x1.80b2575ab211ep+1, 0x1.a33058bd71053p+1,
0x1.cf2bd2bb7b7c3p+1, 0x1.7d1acd38e2814p+1, 0x1.c203c1c384366p+1,
0x1.ec23ad263f3c8p+1, 0x1.32ee3b77f374cp+1, 0x1.8861c890403abp+2,
0x1.20b88e5f2dd1p+2, 0x1.bf2f0d5bb66c1p+1, 0x1.64c85bc2b16dbp+1,
0x1.d317917429241p+1, 0x1.b8fd2e72be54ep+1, 0x1.66fdd13277eaap+2,
0x1.50a445a705d4fp+1, 0x1.c7401e04a6794p+1, 0x1.1df91bf1e729ap+1,
0x1.fa2090fda28b6p+1, 0x1.0a21a1003bfb9p+1, 0x1.597ced1a85fc1p+2,
0x1.0ea6c2d661413p+2, 0x1.b31fa4fddfe77p+1, 0x1.b5de441555985p+1,
0x1.125f895e3c29bp+2, 0x1.5226af9c6e5bep+1, 0x1.c82f3e798c2a5p+1,
0x1.5500f50484c55p+1, 0x1.7734f0935f093p+1, 0x1.66ea98ceb139ap+2,
0x1.3e77c6e31d4dfp+2, 0x1.cf4c27cadf2cbp+1, 0x1.a0f177862c947p+1,
0x1.f41ad306b9119p+1, 0x1.eda22864363bcp+1, 0x1.b52b159975971p+1,
0x1.327d2d250b13dp+2, 0x1.679d564813fdp+1, 0x1.26526e80daf98p+2,
0x1.86a55490f9a6fp+1, 0x1.b35a6f90bd69bp+1), Gini = c(0x1.6211f77768p-5,
0x1.5c2904f3cp-6, 0x1.c8f8cbfbfd4p-2, 0x1.c5c1414a4a4p-3, 0x1.f2b627ef4dp-2,
0x1.218e089f85e8p-2, 0x1.97842a36ded5p-1, 0x1.7f05d4e42c8cp-1,
0x1.5a1c4702389cp-1, 0x1.b3c4b9799418p-1, 0x1.c658a1c658ap-6,
0x1.8ff7050fb3a4p-1, 0x0p+0, 0x1.002ff834778p-4, 0x1.0b510556723cp-1,
0x1.3e820aae0465p-1, 0x1.2ab5f34e47efp-1, 0x1.242e6bdc8058p-1,
0x1.081612133776p-1, 0x1.828eba18216p-3, 0x1.4303b5cc0ed7p-1,
0x1.76001a302ea6p-2, 0x1.17fb89c2a6348p-1, 0x1.a449626d513cp-2,
0x1.258bf258bf26p-2, 0x1.db5264fcf02p-3, 0x1.6d60abd10fb8p-2,
0x1.1a823d15daadp-1, 0x1.81587febbc3cp-2, 0x1.5bd47b107ff4p-2,
0x1.f4d03df4d03ep-2, 0x1.f7bef7defbep-2, 0x1.3855f7268edbp-1,
0x1.20b8fb0b8fbp-1, 0x1.3ef6c074fccp-3, 0x1.ad2ddad2ddbp-2, 0x1.c46d00fe9b8cp-2,
0x1.101b4e81b4e9p-1, 0x1.5d10ebcdc852p-2, 0x1.81cf62c7a0d8p-2,
0x1.c44444444444p-2, 0x1.0ca722b8ca7p-2, 0x1.1b4e81b4e81bp-2,
0x1.9d5c0dc82a8p-3, 0x1.05b05b05b05bp-2, 0x0p+0), Chao1 = c(S.chao1 = 0x1.3facp+15,
S.chao1 = 0x1.0042p+15, S.chao1 = 0x1.d5p+11, S.chao1 = 0x1.a8p+10,
S.chao1 = 0x1.2bp+12, S.chao1 = 0x1.3b8p+10, S.chao1 = 0x1.eep+8,
S.chao1 = 0x1.38p+9, S.chao1 = 0x1.6fp+10, S.chao1 = 0x1.2dp+9,
S.chao1 = 0x1.2ap+8, S.chao1 = 0x1.748p+10, S.chao1 = 0x1.08p+6,
S.chao1 = 0x1.4786p+15, S.chao1 = 0x1.22ep+11, S.chao1 = 0x1.86p+8,
S.chao1 = 0x1.b8p+5, S.chao1 = 0x1.41p+8, S.chao1 = 0x1.36p+9,
S.chao1 = 0x1.6fcp+12, S.chao1 = 0x1.18p+6, S.chao1 = 0x1.33cp+10,
S.chao1 = 0x1.6p+5, S.chao1 = 0x1.a5p+9, S.chao1 = 0x1.8p+4,
S.chao1 = 0x1.13cp+12, S.chao1 = 0x1.8dep+12, S.chao1 = 0x1.92p+7,
S.chao1 = 0x1.8ap+7, S.chao1 = 0x1.064p+13, S.chao1 = 0x1.f3p+8,
S.chao1 = 0x1.9ap+9, S.chao1 = 0x1.41p+8, S.chao1 = 0x1.74p+7,
S.chao1 = 0x1.254cp+14, S.chao1 = 0x1.1cdp+12, S.chao1 = 0x1.a4p+7,
S.chao1 = 0x1.14p+8, S.chao1 = 0x1.e4p+7, S.chao1 = 0x1.fcp+7,
S.chao1 = 0x1.8ap+7, S.chao1 = 0x1.14ep+11, S.chao1 = 0x1.7p+5,
S.chao1 = 0x1.3eap+11, S.chao1 = 0x1.d8p+5, S.chao1 = 0x1.d1p+8
), Simpson = c(0x0p+0, 0x1.0624dd2f1a9fcp-10, 0x1.89374bc6a7efap-9,
0x1.47ae147ae147bp-8, 0x1.89374bc6a7efap-9, 0x1.89374bc6a7efap-7,
0x1.020c49ba5e354p-3, 0x1.eb851eb851eb8p-4, 0x1.353f7ced91687p-3,
0x1.3126e978d4fdfp-3, 0x1.eb851eb851eb8p-6, 0x1.2f1a9fbe76c8bp-4,
0x1.74bc6a7ef9db2p-4, 0x1.89374bc6a7efap-9, 0x1.4fdf3b645a1cbp-5,
0x1.4bc6a7ef9db23p-4, 0x1.95810624dd2f2p-4, 0x1.db22d0e560419p-5,
0x1.16872b020c49cp-4, 0x1.0624dd2f1a9fcp-7, 0x1.0624dd2f1a9fcp-3,
0x1.a9fbe76c8b439p-5, 0x1.53f7ced916873p-3, 0x1.3f7ced916872bp-5,
0x1.4fdf3b645a1cbp-3, 0x1.26e978d4fdf3bp-7, 0x1.0e5604189374cp-4,
0x1.26e978d4fdf3bp-4, 0x1.78d4fdf3b645ap-5, 0x1.4fdf3b645a1cbp-5,
0x1.70a3d70a3d70ap-3, 0x1.5c28f5c28f5c3p-4, 0x1.6666666666666p-3,
0x1.8b4395810624ep-3, 0x1.cac083126e979p-8, 0x1.5810624dd2f1bp-6,
0x1.3333333333333p-4, 0x1.b22d0e5604189p-4, 0x1.eb851eb851eb8p-6,
0x1.0624dd2f1a9fcp-5, 0x1.ba5e353f7ced9p-5, 0x1.47ae147ae147bp-6,
0x1.374bc6a7ef9dbp-4, 0x1.26e978d4fdf3bp-6, 0x1.e353f7ced9168p-5,
0x1.0e5604189374cp-5), UC50 = c(1547L, 576L, 183L, 112L, 173L,
53L, 3L, 3L, 3L, 2L, 17L, 5L, 6L, 237L, 14L, 4L, 4L, 7L, 5L,
136L, 3L, 10L, 3L, 12L, 3L, 106L, 36L, 6L, 8L, 32L, 3L, 7L, 2L,
4L, 141L, 36L, 10L, 5L, 15L, 13L, 8L, 55L, 6L, 48L, 8L, 16L)), class = c("tbl_df",
"tbl", "data.frame"), row.names = c(NA, -46L))
  # expect_true(rlang::is_true(all.equal.list(tt1 %>% dplyr::arrange(timePointDays,patient,numUniqSites),
  #                                           tt2%>% dplyr::arrange(timePointDays,patient,numUniqSites))))
  expect_equal(tt1 %>% dplyr::arrange(timePointDays,patient,numUniqSites),
               tt2 %>% dplyr::arrange(timePointDays,patient,numUniqSites))
})
